#!/bin/bash

# Jira CLI Helper Functions for Creating Stories and Tasks
# Based on your existing jira-cli setup with project DT1 and label DE

# Function to create a Jira Story
# Usage: jcs "Story title" -C component ["description"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]
jcs() {
    local title="$1"
    local description=""
    local component=""
    local labels=""
    local use_default_label=true
    local priority=""
    local status=""
    local parent=""
    local assignee=""
    
    if [[ -z "$title" ]]; then
        echo "Error: Story title is required"
        echo "Usage: jcs \"Story title\" -C component [\"description\"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]"
        return 1
    fi
    
    # Shift past the title
    shift
    
    # Parse options and description
    while [[ $# -gt 0 ]]; do
        case $1 in
            -C|--component)
                component="$2"
                shift 2
                ;;
            -l|--label)
                labels="$2"
                use_default_label=false
                shift 2
                ;;
            -y|--priority)
                priority="$2"
                shift 2
                ;;
            -S|--status)
                status="$2"
                shift 2
                ;;
            -P|--parent)
                parent="$2"
                shift 2
                ;;
            -a|--assignee)
                assignee="$2"
                shift 2
                ;;
            -*)
                echo "Unknown option: $1"
                shift
                ;;
            *)
                # If it's not an option, treat it as description
                description="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$component" ]]; then
        echo "Error: Component is required"
        echo "Usage: jcs \"Story title\" -C component [\"description\"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]"
        return 1
    fi
    
    local cmd="jira issue create --no-input -C \"$component\" -p DT1 -t Story -s \"$title\""
    
    # Handle labels
    if [[ "$use_default_label" == true ]]; then
        cmd="$cmd --label \"DE\""
    elif [[ -n "$labels" ]]; then
        # Split comma-separated labels and add each one
        IFS=',' read -ra LABEL_ARRAY <<< "$labels"
        for label in "${LABEL_ARRAY[@]}"; do
            # Trim whitespace
            label=$(echo "$label" | xargs)
            cmd="$cmd --label \"$label\""
        done
    fi
    
    if [[ -n "$description" ]]; then
        cmd="$cmd -b \"$description\""
    fi
    
    if [[ -n "$priority" ]]; then
        cmd="$cmd -y \"$priority\""
    fi
    
    if [[ -n "$assignee" ]]; then
        cmd="$cmd -a \"$assignee\""
    fi
    
    if [[ -n "$parent" ]]; then
        cmd="$cmd -P \"$parent\""
    fi
    
    # Execute create command and capture issue key
    local create_output
    create_output=$(eval "$cmd")
    echo "$create_output"
    
    # If status is specified, move the issue
    if [[ -n "$status" ]]; then
	# Map status aliases to full status names
        case "$status" in
            "todo")
                status="Selected For Development"
                ;;
            "backlog")
                status="Backlog"
                ;;
            "doing")
                status="In Progress"
                ;;
            # Keep original status if no alias matches
            *)
                # No change needed
                ;;
        esac
        local issue_key
	issue_key=$(echo "$create_output" | grep -o '[A-Z][A-Z0-9]*-[0-9]\+' | head -1)
        if [[ -n "$issue_key" ]]; then
            echo "Moving $issue_key to status: $status"
            jira issue move "$issue_key" "$status"
        else
            echo "Warning: Could not extract issue key to move to status '$status'"
        fi
    fi
}

# Function to create a Jira Task
# Usage: jct "Task title" -C component ["description"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]
jct() {
    local title="$1"
    local description=""
    local component=""
    local labels=""
    local use_default_label=true
    local priority=""
    local status=""
    local parent=""
    local assignee=""
    
    if [[ -z "$title" ]]; then
        echo "Error: Task title is required"
        echo "Usage: jct \"Task title\" -C component [\"description\"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]"
        return 1
    fi
    
    # Shift past the title
    shift
    
    # Parse options and description
    while [[ $# -gt 0 ]]; do
        case $1 in
            -C|--component)
                component="$2"
                shift 2
                ;;
            -l|--label)
                labels="$2"
                use_default_label=false
                shift 2
                ;;
            -y|--priority)
                priority="$2"
                shift 2
                ;;
            -S|--status)
                status="$2"
                shift 2
                ;;
            -P|--parent)
                parent="$2"
                shift 2
                ;;
            -a|--assignee)
                assignee="$2"
                shift 2
                ;;
            -*)
                echo "Unknown option: $1"
                shift
                ;;
            *)
                # If it's not an option, treat it as description
                description="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$component" ]]; then
        echo "Error: Component is required"
        echo "Usage: jct \"Task title\" -C component [\"description\"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]"
        return 1
    fi
    
    local cmd="jira issue create --no-input -C \"$component\" -p DT1 -t Task -s \"$title\""
    
    # Handle labels
    if [[ "$use_default_label" == true ]]; then
        cmd="$cmd --label \"DE\""
    elif [[ -n "$labels" ]]; then
        # Split comma-separated labels and add each one
        IFS=',' read -ra LABEL_ARRAY <<< "$labels"
        for label in "${LABEL_ARRAY[@]}"; do
            # Trim whitespace
            label=$(echo "$label" | xargs)
            cmd="$cmd --label \"$label\""
        done
    fi
    
    if [[ -n "$description" ]]; then
        cmd="$cmd -b \"$description\""
    fi
    
    if [[ -n "$priority" ]]; then
        cmd="$cmd -y \"$priority\""
    fi
    
    if [[ -n "$assignee" ]]; then
        cmd="$cmd -a \"$assignee\""
    fi
    
    if [[ -n "$parent" ]]; then
        cmd="$cmd -P \"$parent\""
    fi
    
    # Execute create command and capture issue key
    local create_output
    create_output=$(eval "$cmd")
    echo "$create_output"
    
    # If status is specified, move the issue
    if [[ -n "$status" ]]; then
	# Map status aliases to full status names
        case "$status" in
            "todo")
                status="Selected For Development"
                ;;
            "backlog")
                status="Backlog"
                ;;
            "doing")
                status="In Progress"
                ;;
            # Keep original status if no alias matches
            *)
                # No change needed
                ;;
        esac
        local issue_key
	issue_key=$(echo "$create_output" | grep -o '[A-Z][A-Z0-9]*-[0-9]\+' | head -1)
        if [[ -n "$issue_key" ]]; then
            echo "Moving $issue_key to status: $status"
            jira issue move "$issue_key" "$status"
        else
            echo "Warning: Could not extract issue key to move to status '$status'"
        fi
    fi
}

# Helper function to show usage examples
jira_help() {
    cat << 'EOF'
Jira CLI Helper Functions Usage:

Functions:
  jcs "Story title" -C component ["description"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]
  jct "Task title" -C component ["description"] [-l label1,label2] [-y priority] [-S status] [-P parent] [-a assignee]

Required:
  - Title (first argument)
  - Component (-C flag)

Optional:
  - Description (any non-flag argument)
  - Labels (-l flag, defaults to "DE" if not specified)
    - Multiple labels: -l "urgent,backend,sprint-1"
    - Single label: -l "critical"
    - Default: Uses "DE" when -l is omitted
  - Priority (-y flag)
  - Status (-S flag, moves issue after creation)
  - Parent (-P flag, links to parent issue)
  - Assignee (-a flag, assigns issue to user)

Examples:
  jcs "Implement user authentication" -C Backend
  jcs "Add login page" -C Frontend "Create responsive login form" -y High -a john.doe
  jcs "Critical bug fix" -C Backend "Fix memory leak" -l "urgent,bug,critical" -y Highest
  jct "Update documentation" -C DevOps "Update API docs for new endpoints" -l "docs,api" -a jane.smith
  jct "Review pull request" -C Frontend -S "In Progress" -l "review,frontend" -a reviewer
  jcs "User story subtask" -C Backend -P "DT1-123" "Child story under epic" -a developer
  jct "Implementation task" -C Frontend -P "DT1-456" "Task linked to story" -a frontend.dev
  jim "DT1-789" "doing"  # Move issue to In Progress
  jim "DT1-101" "Selected For Development"  # Move using full status name

Status aliases:
  - "todo" → "Selected For Development"
  - "backlog" → "Backlog"
  - "doing" → "In Progress"

Default values:
  - Project: DT1
  - Label: DE (only when -l is not specified)
  - Component: REQUIRED (must specify with -C)
  - Assignee: None (can be specified with -a)

Label behavior:
  - No -l flag: Uses default "DE" label
  - With -l flag: Uses specified labels, overrides default
  - Multiple labels: Separate with commas: -l "label1,label2,label3"
EOF
}

# Function to move Jira issue to a different status
# Usage: jim <issue_key> <status>
jim() {
    local issue_key="$1"
    local status="$2"
    
    if [[ -z "$issue_key" || -z "$status" ]]; then
        echo "Error: Issue key and status are required"
        echo "Usage: jim <issue_key> <status>"
        echo "Status aliases: todo, backlog, doing (or use full status names)"
        return 1
    fi
    
    # Map status aliases to full status names
    case "$status" in
        "todo")
            status="Selected For Development"
            ;;
        "backlog")
            status="Backlog"
            ;;
        "doing")
            status="In Progress"
            ;;
        # Keep original status if no alias matches
        *)
            # No change needed
            ;;
    esac
    
    echo "Moving $issue_key to status: $status"
    jira issue move "$issue_key" "$status"
}

# Function to list issues with DE label
# Usage: jil
jil() {
    jira issue list -l DE
}

# Export functions to make them available in the shell
export -f jcs jct jil jim jira_help
